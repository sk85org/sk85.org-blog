<!doctype html><html lang=ja xmlns=http://www.w3.org/1999/xhtml><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=filename content="20210223_245718.md"><link rel=icon href=data:,%89PNG%0D%0A%1A%0A><title>自宅のintel-nucにVPS経由でssh tunnelする</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap" rel=stylesheet><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/font.css></head><body><header><a href=/ title=top><span class=menu>top</span></a>&nbsp;<a href=/archives/ title=archives><span class=menu>archives</span></a>&nbsp;<a href=/tags/ title=tags><span class=menu>tags</span></a>&nbsp;<a href=/about/ title=about><span class=menu>about</span></a>&nbsp;</header><h1>自宅のintel-nucにVPS経由でssh tunnelする</h1><form method=get action=https://dsearch.sk85.org/cgi/><input type=text name=phrase size=20>
<input type=submit value=Search>
<input type=hidden name=enc value=UTF-8></form><time datetime=2021-02-23 id=single_page_date>2021-02-23&ensp;(火)</time>
|
Tags:
<span><a href=/tags/memo>memo</a></span>
<span><a href=/tags/></a></span>
|
<span><a href=/n%E5%B9%B4%E6%97%A5%E8%A8%98/0223>n年日記</a></span><p>ここが大変参考になり、ほぼ真似しただけです。<br><a href=https://blog.alprosys.com/2019/01/06/reverse-ssh-tunneling/>https://blog.alprosys.com/2019/01/06/reverse-ssh-tunneling/</a></p><h3 id=概要>概要</h3><p>sshのトンネル機能を利用して、自宅外からVPS経由で自宅サーバー(intel-nuc)にsshでログインする</p><h3 id=自宅サーバーの設定>自宅サーバーの設定</h3><h4 id=sshの設定>sshの設定</h4><ol><li>VPSにログインできるように、自宅サーバーの公開鍵をvpsの.ssh/authorized_keysに登録する</li><li>configファイルを.ssh/以下に作成する</li></ol><pre tabindex=0><code>    Host vps-ssh-tunnel
    HostName public.example.com
    User vps
    ServerAliveInterval 60
    ExitOnForwardFailure yes
    TCPKeepAlive no
    IdentityFile /path/to/public.example.com.rev.id_ecdsa
</code></pre><ol start=3><li>ssh vps-ssh-tunnel して接続確認</li></ol><h4 id=自動起動の設定>自動起動の設定</h4><ol><li>systemdのserviceを作る<br>~/.config/systemd/user/以下にvps-ssh-tunnel.serviceを作成
踏み台がVPS(外部)でnucは内部なので、SSHではリモートフォワードを使う</li></ol><ul><li><a href="https://blue-red.ddo.jp/~ao/wiki/wiki.cgi?page=SSH%A4%CB%A4%E8%A4%EB%A5%DD%A1%BC%A5%C8%A5%D5%A5%A9%A5%EF%A1%BC%A5%C7%A5%A3%A5%F3%A5%B0#p3">SSHによるポートフォワーディング</a></li></ul><pre tabindex=0><code>    [Unit]
    Description= SSH Tunneling to VPS
    [Service]
    ExecStart=ssh -NR 2222:intel-nuc:22 vps-ssh-tunnel
    Type=simple
    Restart=always
    [Install]
    WantedBy=default.target
</code></pre><p>この設定でVPSサーバー上でport 2222に流れる通信がintel-nucのport 22に転送される。</p><ol start=2><li>起動を確認</li></ol><pre tabindex=0><code>    systemctl --user daemon-reload
    systemctl --user start public-rev
    systemctl --user enable public-rev
    systemctl --user status して動いていることを確認
</code></pre><ol start=3><li>一般ユーザーでもserviceを起動起動する<br>ユーザーレベルで起動したサービスは起動直後やログオフ時には実行されないようなので、<br>以下を参考に設定を変える<br><a href=https://harpyja.daemon.asia/wiki/Unix/systemd-continue-user-service>https://harpyja.daemon.asia/wiki/Unix/systemd-continue-user-service</a><br>/etc/systemd/logind.conf の</li></ol><pre tabindex=0><code>    KillUserProcesses=no
</code></pre><p>また</p><pre tabindex=0><code>    loginctl enable-linger &lt;username&gt;
</code></pre><p>をするらしい。</p><h3 id=vpsサーバーの設定>VPSサーバーの設定</h3><p>自宅サーバーにログインできるように、VPSサーバーの公開鍵を自宅サーバーの.ssh/authorized_keysに登録する。VPSサーバー上で自宅サーバーに接続できるか確認</p><pre tabindex=0><code>    ssh username@localhost -p 2222 でログインできるか確認
</code></pre><h3 id=クライアントの設定>クライアントの設定</h3><p>ターミナル上でVPSにログインして、そこからまたintel-nucに接続するのが面倒なので、<br>クライアントの.ssh/configに以下を追加</p><pre tabindex=0><code>    Host private.intel-nuc
    HostName localhost
    Port 2222
    User username
    ProxyCommand ssh -W %h:%p vps@public.example.com
    DynamicForward 2222
    ServerAliveInterval 60
</code></pre><p>ssh private.intel-nuc でvps経由で接続できるか確認</p><h3 id=sftpでも接続する>SFTPでも接続する</h3><p>参考 <a href=https://qiita.com/Zero_Kohaku/items/308c73fa1ab355699032>SSHトンネルでSFTP接続</a><br>クライアント端末のターミナル上で、VPSに対してローカルフォワードで接続する。
VPS上でのフォワード先をlocalhostにしてやれば、クライアント端末のポート2000からの通信を、VPSのポート2222対してフォワードして、2222に対する通信は更に、intel-nucのポート22にリモートフォワードされることになる。</p><pre tabindex=0><code>ssh -L 2000:localhost:2222 vps@public.example.com
</code></pre><p>トンネルを確立した状態で、FFFTPやTRANSMITでlocalhost:2222に接続すればVPS経由でsftpができる。
クライアントの.ssh/configに以下を追加</p><pre tabindex=0><code>    Host private.intel-nuc.sftp
    HostName public.example.com
    User vps
    LocalForward 2000 localhost:2222
    IdentityFile /path/to/public.example.com.rev.id_ecdsa
</code></pre><p>こうすれば、ターミナル上で<br>ssh private.intel-nuc.sftp<br>で接続できるので便利</p><script src=https://unpkg.com/hotkeys-js/dist/hotkeys.min.js></script>
<script>hotkeys("n,p",function(e,t){switch(t.key){case"n":document.getElementById("next-post-link").click();break;case"p":document.getElementById("previous-post-link").click()}})</script><div id=pagination><a href=/posts/2021/02/22/517455/ id=previous-post-link><span>Prev</span></a>
&ensp;
<a href=/posts/2021/02/23/427801/ id=next-post-link><span>Next</span></a></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//https-d-sk85-org.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><footer></footer></body></html>