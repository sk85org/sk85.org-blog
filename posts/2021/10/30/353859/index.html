<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Your site description"><link rel=alternate type=application/rss+xml href=//index.xml title=d.sk85.org/><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/style.min.css><title>Cloudflare Tunnelを使ってローカルのサーバーを安全に公開する</title></head><body><header id=banner><h2><a href=/>d.sk85.org/</a></h2><nav><ul><li><a href=/posts/ title=posts>posts</a></li><li><a href=/archives/ title=archives>archives</a></li><li><a href=/tags/ title=tags>tags</a></li><li><a href=/about/ title=about>about</a></li></ul></nav></header><form method=get action=https://dsearch.sk85.org/cgi/><div><input type=text name=phrase size=20>
<input type=submit value=Search>
<input type=hidden name=enc value=UTF-8></div></form><main id=content><script src=https://unpkg.com/hotkeys-js/dist/hotkeys.min.js></script>
<script type=text/javascript>hotkeys("n,p",function(e,t){switch(t.key){case"n":document.getElementById("next-post-link").click();break;case"p":document.getElementById("previous-post-link").click()}})</script><article><header id=post-header><h1>Cloudflare Tunnelを使ってローカルのサーバーを安全に公開する</h1><time>Sat. October 30, 2021</time><div id=filename><a href=https://github.com/sk85org/sk85.org-blog/blob/main/content/posts//20211030_353859.md>20211030_353859.md</a></div><a href=/tags/memo/>memo</a>&nbsp;<a href=/tags//></a>&nbsp;</header><h3 id=vpsをやめる>VPSをやめる</h3><p>indigoのVPSサーバー上に<a href=https://tailscale.com/>Tailscale</a>をインストールして、自宅のサーバーにVPNで接続して、nginxのproxyとBASIC認証を使っていたのだけれど<a href=/posts/2021/09/28/429812/>*</a>、自宅からVPSサーバーを迂回して大きなファイルを転送するとループを検知してか、30分ぐらいIPアドレスがブロックされてしまう。運用も面倒だなと思っていたら、<a href=https://www.cloudflare.com/products/tunnel/>Cloudflare Tunnel</a>を使うと、無料で認証まで簡単にやってくれるらしい。実際やってみると簡単。VPS借りて手動でプロキシ立てるのがばからしくなる。</p><h3 id=メモ>メモ</h3><h4 id=前提>前提</h4><p>必要なのは</p><ol><li>自分でネームサーバーを設定できる独自ドメイン</li></ol><h4 id=cloudflareにドメインを登録してネームサーバーをcloudflareに設定する>Cloudflareにドメインを登録してネームサーバーをCloudflareに設定する</h4><p>Cloudflareが現状のDNS設定を読み込んでくれ、ネームサーバーの変更をガイドしてくれる</p><h4 id=cloudflare-for-teamsに登録>Cloudflare for Teamsに登録</h4><h4 id=アプリケーションの追加>アプリケーションの追加</h4><p>Cloudflare for Teamsのダッシュボードからアプリケーションを追加する。Application URLはアクセスしたいURLを指定する。認証方法はメールアドレスや、IPアドレス、国等いろいろと選べる。<div style=text-align:center><img src="https://img.sk85.org/imaginary/resize?width=600&quality=80&file=20211030-05-14-11-NPFd9meNr7exX4TYqzw3.png" loading=“lazy”></img><figcaption><a href="https://img.sk85.org/imaginary/resize?width=2000&quality=100&file=20211030-05-14-11-NPFd9meNr7exX4TYqzw3.png">(LargeSize)</a></figcaption></div><div style=text-align:center><img src="https://img.sk85.org/imaginary/resize?width=600&quality=80&file=20211030-05-14-11-KOagNzNb8tL1hIFTPoz9.png" loading=“lazy”></img><figcaption><a href="https://img.sk85.org/imaginary/resize?width=2000&quality=100&file=20211030-05-14-11-KOagNzNb8tL1hIFTPoz9.png">(LargeSize)</a></figcaption></div></p><h4 id=cloudflaredのインストール>cloudflaredのインストール</h4><p><a href=https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup>Get started · Cloudflare for Teams documentation</a></p><h4 id=ログインとtunnelsの作成tunnelの作成はnon-rootで可能>ログインとTunnelsの作成(tunnelの作成はnon rootで可能)</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>$ cloudflared tunnel login #(表示されるURLにアクセスする)
</span></span><span class=line><span class=cl>$ loudflared tunnel create NAME #(NAMEは任意のチャンネル名)
</span></span><span class=line><span class=cl>Tunnel credentials written to /path/to/.cloudflared/&lt;Tunnel-UUID&gt;.json. 
</span></span><span class=line><span class=cl>cloudflared chose this file based on where your origin certificate was found.
</span></span><span class=line><span class=cl>Keep this file secret. To revoke these credentials, delete the tunnel.
</span></span></code></pre></div><p>ダッシュボードから作成したTunnelsのTunnel-UUIDが確認できる。削除はCLIもしくはダッシュボードから可能。<div style=text-align:center><img src="https://img.sk85.org/imaginary/resize?width=900&quality=80&file=20211030-04-56-26-5A-HtfL5EQlZreSa3l4Y.png" loading=“lazy”></img><figcaption><a href="https://img.sk85.org/imaginary/resize?width=2000&quality=100&file=20211030-04-56-26-5A-HtfL5EQlZreSa3l4Y.png">(LargeSize)</a></figcaption></div>ホームフォルダ上の.cloudflaredディレクトリの中に設定ファイルconfig.ymlを作成する。
サーバー上のサービスとバーチャルホストを対応させる。サービスごとにTunnelを作成することもできるが、簡単にするために<a href=https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/configuration/configuration-file/ingress>Ingress rules</a>にする。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-config.yml data-lang=config.yml><span class=line><span class=cl><span class=nt>tunnel</span><span class=p>:</span><span class=w> </span><span class=l>&lt;Tunnel-UUID&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>credentials-file</span><span class=p>:</span><span class=w> </span><span class=l>/path/to/.cloudflared/&lt;Tunnel-UUID&gt;.json</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ingress</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>hostname</span><span class=p>:</span><span class=w> </span><span class=l>www.example.net</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w> </span><span class=l>http://localhost:8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>hostname</span><span class=p>:</span><span class=w> </span><span class=l>www1.example.net</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w> </span><span class=l>http://localhost:8081</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>service</span><span class=p>:</span><span class=w> </span><span class=l>http_status:404</span><span class=w> </span><span class=c># (catch-allの記述が必要らしい)</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>$ cloudflared tunnel ingress validate #(config.ymlの文法チェック)
</span></span><span class=line><span class=cl>Validating rules from /path/to/.cloudflared/config.yml
</span></span><span class=line><span class=cl>OK
</span></span></code></pre></div><h4 id=tunnelsの確立>Tunnelsの確立</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>$ cloudflared tunnel run &lt;Tunnel-UUID or NAME&gt;
</span></span></code></pre></div><p>問題なければ、ダッシュボード上でステータスがACTGIVEになる</p><h4 id=cnameレコードの追加>CNAMEレコードの追加</h4><p><div style=text-align:center><img src="https://img.sk85.org/imaginary/resize?width=900&quality=80&file=20211030-05-29-35-kR0HJitFJ_xol0u--AeH.png" loading=“lazy”></img><figcaption><a href="https://img.sk85.org/imaginary/resize?width=2000&quality=100&file=20211030-05-29-35-kR0HJitFJ_xol0u--AeH.png">(LargeSize)</a></figcaption></div>DNSの設定画面から、CNAMEレコードを追加する。<br>ターゲットはTunnel-UUID.cfargotunnel.comになるようだ。
<a href=https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/routing-to-tunnel/dns>DNS record · Cloudflare for Teams documentation</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>$ cloudflared tunnel route dns &lt;UUID or NAME&gt; www.example.net
</span></span><span class=line><span class=cl>$ cloudflared tunnel route dns &lt;UUID or NAME&gt; www1.example.net
</span></span><span class=line><span class=cl> # (CLIからCNAMEを順次追加していくことも可能)
</span></span></code></pre></div><ul><li>動作確認<br>ドメインにアクセスすると、認証画面が出る。<div style=text-align:center><img src="https://img.sk85.org/imaginary/resize?width=900&quality=80&file=20211030-05-55-18-I_9fSGY3x9pq67CATelV.png" loading=“lazy”></img><figcaption><a href="https://img.sk85.org/imaginary/resize?width=2000&quality=100&file=20211030-05-55-18-I_9fSGY3x9pq67CATelV.png">(LargeSize)</a></figcaption></div></li><li>cloudflaredをサービスに登録する<br><a href=https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/run-tunnel/run-as-service>Run as a service · Cloudflare for Teams documentation</a></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>$ sudo cloudflared --config /path/to/.cloudflared/config.yml service install
</span></span><span class=line><span class=cl>$ sudo systemctl start cloudflared
</span></span><span class=line><span class=cl>$ sudo systemctl enable cloudflared
</span></span></code></pre></div><p>これは便利だー</p><h4 id=参考>参考</h4><ul><li><a href=https://zenn.dev/devneko/articles/3b47c933b11e85>最近知ったCloudflareで実はこんなこともできる集</a></li><li><a href=https://zenn.dev/grarich/articles/4fcf016080fbcb>Argo Tunnel でブラウザからSSH接続をする方法</a></li><li><a href=https://zenn.dev/syuneara/articles/fc37ff0adbf269>cloudflaredの動かし方</a></li></ul></article><div class=pagination style=text-align:center><span class=next-post><a href=/posts/2021/10/30/300029/ id=previous-post-link>← 2021-10-30</a></span>
&nbsp;/&nbsp;
<span class=previous-post><a href=/posts/2021/10/31/59562/ id=next-post-link>2021-10-31 →</a></span></div></main><footer id=footer></footer></body></html>