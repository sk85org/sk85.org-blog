<!doctype html><html lang=ja xmlns=http://www.w3.org/1999/xhtml><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=filename content="20211030_353859.md"><link rel=icon href=data:,%89PNG%0D%0A%1A%0A><title>Cloudflare Tunnelを使ってローカルのサーバーを安全に公開する</title>
<link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap" rel=stylesheet><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/font.css></head><body><header><a href=/ title=top><span class=menu>top</span></a>&nbsp;<a href=/archives/ title=archives><span class=menu>archives</span></a>&nbsp;<a href=/tags/ title=tags><span class=menu>tags</span></a>&nbsp;<a href=/about/ title=about><span class=menu>about</span></a>&nbsp;</header><h1>Cloudflare Tunnelを使ってローカルのサーバーを安全に公開する</h1><form method=get action=https://dsearch.sk85.org/cgi/><input type=text name=phrase size=20>
<input type=submit value=Search>
<input type=hidden name=enc value=UTF-8></form><time datetime=2021-10-30 id=single_page_date>2021-10-30&ensp;(土)
</time>|
Tags:
<span><a href=/tags/memo>memo</a>
</span><span><a href=/tags/></a></span>|
<span><a href=/n%E5%B9%B4%E6%97%A5%E8%A8%98/1030>n年日記</a></span><h3 id=vpsをやめる>VPSをやめる</h3><p>indigoのVPSサーバー上に<a href=https://tailscale.com/>Tailscale</a>をインストールして、自宅のサーバーにVPNで接続して、nginxのproxyとBASIC認証を使っていたのだけれど<a href=/posts/2021/09/28/429812/>*</a>、自宅からVPSサーバーを迂回して大きなファイルを転送するとループを検知してか、30分ぐらいIPアドレスがブロックされてしまう。運用も面倒だなと思っていたら、<a href=https://www.cloudflare.com/products/tunnel/>Cloudflare Tunnel</a>を使うと、無料で認証まで簡単にやってくれるらしい。実際やってみると簡単。VPS借りて手動でプロキシ立てるのがばからしくなる。</p><h3 id=メモ>メモ</h3><h4 id=前提>前提</h4><p>必要なのは</p><ol><li>自分でネームサーバーを設定できる独自ドメイン</li></ol><h4 id=cloudflareにドメインを登録してネームサーバーをcloudflareに設定する>Cloudflareにドメインを登録してネームサーバーをCloudflareに設定する</h4><p>Cloudflareが現状のDNS設定を読み込んでくれ、ネームサーバーの変更をガイドしてくれる</p><h4 id=cloudflare-for-teamsに登録>Cloudflare for Teamsに登録</h4><h4 id=アプリケーションの追加>アプリケーションの追加</h4><p>Cloudflare for Teamsのダッシュボードからアプリケーションを追加する。Application URLはアクセスしたいURLを指定する。認証方法はメールアドレスや、IPアドレス、国等いろいろと選べる。
<span class=img style=text-align:center><a href="https://img.sk85.org/imaginary/resize?width=2000&quality=100&file=20211030-05-14-11-NPFd9meNr7exX4TYqzw3.png"><img src="https://img.sk85.org/imaginary/resize?width=600&quality=80&file=20211030-05-14-11-NPFd9meNr7exX4TYqzw3.png" loading=“lazy”></a><figcaption></figcaption></span><span class=img style=text-align:center><a href="https://img.sk85.org/imaginary/resize?width=2000&quality=100&file=20211030-05-14-11-KOagNzNb8tL1hIFTPoz9.png"><img src="https://img.sk85.org/imaginary/resize?width=600&quality=80&file=20211030-05-14-11-KOagNzNb8tL1hIFTPoz9.png" loading=“lazy”></a><figcaption></figcaption></span></p><h4 id=cloudflaredのインストール>cloudflaredのインストール</h4><p><a href=https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup>Get started · Cloudflare for Teams documentation</a></p><h4 id=ログインとtunnelsの作成tunnelの作成はnon-rootで可能>ログインとTunnelsの作成(tunnelの作成はnon rootで可能)</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>$ cloudflared tunnel login #(表示されるURLにアクセスする)
</span></span><span style=display:flex><span>$ loudflared tunnel create NAME #(NAMEは任意のチャンネル名)
</span></span><span style=display:flex><span>Tunnel credentials written to /path/to/.cloudflared/&lt;Tunnel-UUID&gt;.json. 
</span></span><span style=display:flex><span>cloudflared chose this file based on where your origin certificate was found.
</span></span><span style=display:flex><span>Keep this file secret. To revoke these credentials, delete the tunnel.
</span></span></code></pre></div><p>ダッシュボードから作成したTunnelsのTunnel-UUIDが確認できる。削除はCLIもしくはダッシュボードから可能。
<span class=img style=text-align:center><a href="https://img.sk85.org/imaginary/resize?width=2000&quality=100&file=20211030-04-56-26-5A-HtfL5EQlZreSa3l4Y.png"><img src="https://img.sk85.org/imaginary/resize?width=900&quality=80&file=20211030-04-56-26-5A-HtfL5EQlZreSa3l4Y.png" loading=“lazy”></a><figcaption></figcaption></span>ホームフォルダ上の.cloudflaredディレクトリの中に設定ファイルconfig.ymlを作成する。
サーバー上のサービスとバーチャルホストを対応させる。サービスごとにTunnelを作成することもできるが、簡単にするために<a href=https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/configuration/configuration-file/ingress>Ingress rules</a>にする。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-config.yml data-lang=config.yml><span style=display:flex><span><span style=color:#f92672>tunnel</span>: <span style=color:#ae81ff>&lt;Tunnel-UUID&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>credentials-file</span>: <span style=color:#ae81ff>/path/to/.cloudflared/&lt;Tunnel-UUID&gt;.json</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>ingress</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>hostname</span>: <span style=color:#ae81ff>www.example.net</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>service</span>: <span style=color:#ae81ff>http://localhost:8080</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>hostname</span>: <span style=color:#ae81ff>www1.example.net</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>service</span>: <span style=color:#ae81ff>http://localhost:8081</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>service</span>: <span style=color:#ae81ff>http_status:404</span> <span style=color:#75715e># (catch-allの記述が必要らしい)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>$ cloudflared tunnel ingress validate #(config.ymlの文法チェック)
</span></span><span style=display:flex><span>Validating rules from /path/to/.cloudflared/config.yml
</span></span><span style=display:flex><span>OK
</span></span></code></pre></div><h4 id=tunnelsの確立>Tunnelsの確立</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>$ cloudflared tunnel run &lt;Tunnel-UUID or NAME&gt;
</span></span></code></pre></div><p>問題なければ、ダッシュボード上でステータスがACTGIVEになる</p><h4 id=cnameレコードの追加>CNAMEレコードの追加</h4><p><span class=img style=text-align:center><a href="https://img.sk85.org/imaginary/resize?width=2000&quality=100&file=20211030-05-29-35-kR0HJitFJ_xol0u--AeH.png"><img src="https://img.sk85.org/imaginary/resize?width=900&quality=80&file=20211030-05-29-35-kR0HJitFJ_xol0u--AeH.png" loading=“lazy”></a><figcaption></figcaption></span>DNSの設定画面から、CNAMEレコードを追加する。<br>ターゲットはTunnel-UUID.cfargotunnel.comになるようだ。
<a href=https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/routing-to-tunnel/dns>DNS record · Cloudflare for Teams documentation</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>$ cloudflared tunnel route dns &lt;UUID or NAME&gt; www.example.net
</span></span><span style=display:flex><span>$ cloudflared tunnel route dns &lt;UUID or NAME&gt; www1.example.net
</span></span><span style=display:flex><span> # (CLIからCNAMEを順次追加していくことも可能)
</span></span></code></pre></div><ul><li>動作確認<br>ドメインにアクセスすると、認証画面が出る。<span class=img style=text-align:center>
<a href="https://img.sk85.org/imaginary/resize?width=2000&quality=100&file=20211030-05-55-18-I_9fSGY3x9pq67CATelV.png"><img src="https://img.sk85.org/imaginary/resize?width=900&quality=80&file=20211030-05-55-18-I_9fSGY3x9pq67CATelV.png" loading=“lazy”></a><figcaption></figcaption></span></li><li>cloudflaredをサービスに登録する<br><a href=https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/run-tunnel/run-as-service>Run as a service · Cloudflare for Teams documentation</a></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>$ sudo cloudflared --config /path/to/.cloudflared/config.yml service install
</span></span><span style=display:flex><span>$ sudo systemctl start cloudflared
</span></span><span style=display:flex><span>$ sudo systemctl enable cloudflared
</span></span></code></pre></div><p>これは便利だー</p><h4 id=参考>参考</h4><ul><li><a href=https://zenn.dev/devneko/articles/3b47c933b11e85>最近知ったCloudflareで実はこんなこともできる集</a></li><li><a href=https://zenn.dev/grarich/articles/4fcf016080fbcb>Argo Tunnel でブラウザからSSH接続をする方法</a></li><li><a href=https://zenn.dev/syuneara/articles/fc37ff0adbf269>cloudflaredの動かし方</a></li></ul><script src=https://unpkg.com/hotkeys-js/dist/hotkeys.min.js></script><script>hotkeys("n,p",function(e,t){switch(t.key){case"n":document.getElementById("next-post-link").click();break;case"p":document.getElementById("previous-post-link").click()}})</script><div id=pagination><a href=/posts/2021/10/30/300029/ id=previous-post-link><span>Prev</span>
</a>&ensp;
<a href=/posts/2021/10/31/59562/ id=next-post-link><span>Next</span>
</a><script src=https://utteranc.es/client.js repo=sk85org/sk85.org-blog-comment issue-term=pathname theme=preferred-color-scheme crossorigin=anonymous async></script></div><footer></footer></body></html>